<!DOCTYPE HTML>
<html layout:decorate="Layouts/defaultLayout">
    <head>
        <title id="pageTitle">Product name</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/style.css" rel="stylesheet">
        <link href="css/cardStyle.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
        <link href="/css/map.css" rel="stylesheet">

        <style>
            .product-details {
                display: flex;
                align-items: center;
                margin-bottom: 20px;
            }

            .product-image {
                flex: 0 0 auto;
                margin-right: 20px;
                padding: 30px;
            }

            .product-image img {
                max-width: 400px;
                height: auto;
                border-radius: 5px;
                box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            }

            .product-info {
                flex: 1 1 auto;
            }

            .product-name {
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 10px;
            }

            .product-price {
                font-size: 16px;
                margin-bottom: 10px;
            }

            .add-to-cart {
                margin-bottom: 10px;
            }

            .add-to-cart button {
                background-color: #6a8f65;
                color: white;
                padding: 10px 15px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
                transition: background-color 0.3s ease;
            }

            .add-to-cart button:hover {
                background-color: #506b4b;
            }

            .quantity-input {
                width: 50px;
                padding: 5px;
                border: 1px solid #ccc;
                border-radius: 5px;
            }

            .product-description {
                margin-top: 10px;
                font-size: 20px;
                line-height: 1.4;
                color: #555;
            }

            .store-selection  {
                padding: 10px;
                border-radius: 5px;
                background-color: #f1f1f1;
                border: none;
                box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            }

            .store-selection label {
                font-weight: bold;
                margin-right: 10px;
            }

            #locationButton {
                margin-left: 5px;
                padding: 10px 20px;
                background-color: #6a8f65;
                color: #fff;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            #locationButton i {
                margin-right: 5px;
            }

            #locationButton:hover {
                background-color: #506b4b;
            }

            #locationButton:active {
                background-color: #506b4b;
            }

            .modal_p {
                margin: auto;
                display: flex;
                flex-direction: column;
                justify-content: center;
                gap: 0.4rem;
                width: 450px;
                padding: 1.3rem;
                min-height: 250px;
                position: absolute;
                top: 20%;
                background-color: white;
                border: 1px solid #ddd;
                border-radius: 15px;
                z-index: 2;
            }

            .modal_p .flex {
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .modal_p input {
                padding: 0.7rem 1rem;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 0.9em;
            }

            .overlay {
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(3px);
                z-index: 1;
            }

            .hidden {
                display: none;
            }

            .close {
                position: absolute;
                top: 10px;
                right: 10px;
                font-size: 1.5rem;
                font-weight: bold;
                line-height: 1;
                color: #000;
                text-shadow: 0 1px 0 #fff;
                opacity: 0.5;
            }

            .close:hover {
                color: #000;
                text-decoration: none;
                cursor: pointer;
                opacity: 0.75;
            }

            .close:focus,
            .close:active {
                color: #000;
                outline: none;
                opacity: 1;
            }

            .ok{
                cursor:pointer;
                background-color: #eceeef;
                width: 50%;
                margin-inline:auto;
            }

            button:disabled,
            button:disabled:hover,
            button[disabled]{
                cursor: default;
                border: 1px solid #999999;
                background-color: #cccccc;
                color: #666666;
            }

            #snackbar {
                visibility: hidden;
                min-width: 400px;
                margin-left: -200px;
                background-color: #333;
                color: #fff;
                text-align: center;
                border-radius: 2px;
                padding: 16px;
                position: fixed;
                z-index: 1;
                left: 50%;
                bottom: 50px;
            }

            #snackbar.show {
                visibility: visible;
                animation: fadein 0.5s, fadeout 0.5s 2.5s;
            }

            @keyframes fadein {
                from {bottom: 0; opacity: 0;}
                to {bottom: 50px; opacity: 1;}
            }

            @keyframes fadeout {
                from {bottom: 30px; opacity: 1;}
                to {bottom: 0; opacity: 0;}
            }

            .number-input {
                display: flex;
                align-items: center;
            }

            .number-input input {
                width: 100px;
                text-align: center;
            }

            .number-input button {
                width: 40px;
                height: 40px;
                padding: 3px;
                border-radius: 3px;
                color: white;
                border: none;
                cursor: pointer;
            }

            .number-input button:disabled {
                background-color: #ddd !important;
                cursor: not-allowed;
            }

            /* Chrome, Safari, Edge, Opera */
            input::-webkit-outer-spin-button,
            input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            /* Firefox */
            input[type=number] {
                -moz-appearance: textfield;
            }

        </style>
    </head>


<body>
<div layout:fragment="content">

<div class="container-fluid">
    <!--breadcrumb-->
    <div class="row">
        <div class="col-md-12">
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/home">Home</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="#" id="category">Category</a>
                    </li>
                    <li class="breadcrumb-item active" id="whatitem">
                        Product name (pp)
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Add to cart -->
    <section class="modal_p modal order hidden">
        <div th:if='${session.get("store")==null}'>
            <div></div>
            <div class="flex">
                <button class="close" onclick="toggleModal('.order','close')">&times;</button>
            </div>
            <div>
                <h3>Select a supermarket for your order</h3>
            </div>
            <div id="purchaseOptions">Options will appear here if available</div>
            <br>
            <button class="btn ok" onclick="setSupermarket()" style="display: block">Set your supermarket</button>
        </div>
        <div th:if='${session.get("store")!=null}'>
            <h3>Select quantity: </h3>
            <hr><br>
            <div style="display: flex;">
                <p th:text="'Currently available at '+${session.storeName}"></p><p id="qty"> </p>
            </div>
            <div class="number-input">
                <button id="minusButton" style="background-color: #d41d36; margin-right: 5px" onclick="decrementNumber()" disabled>-</button>
                <input id="quantity-input" class="quantity-input" type="number" value="1" min="1" max="10" oninput="validateRange()">
                <button id="plusButton" style="background-color: #6a8f65; margin-left: 5px" onclick="incrementNumber()">+</button>
            </div>
            <br>
            <div class="flex">
                <button class="close" onclick="toggleModal('.order','close')">&times;</button>
            </div>
            <div>
                <button class="btn ok" onclick="addToCart()" style="display: block">Add to Cart</button>
            </div>
        </div>
    </section>
    <div class="overlay hidden"></div>

    <!-- Add to cart -->
    <div id="product-details-container" class="product-details-container"></div>
    <section class="modal_p modal locate hidden">
        <div class="flex">
            <button class="close" onclick="toggleModal('.locate','close')">&times;</button>
        </div>
        <div>
            <h3>Find a supermarket near you</h3>
            <div id="options">Put your options here</div>
        </div>
        <button class="btn ok" onclick="toggleModal('.locate','close')">Okay</button>
    </section>

    <div id="snackbar">Successfully added to cart!</div>

</div>

    <!-- Get session variables -->
    <script th:inline="javascript">
        const storeName = /*[[${session.storeName}]]*/ '';
    </script>
    <script th:inline="javascript">
        const storeId = /*[[${session.store}]]*/ '';
    </script>

    <script>
        // Get the product ID from the query parameter in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        // Fetch the product details from the server
        fetch('/allbyid?id=' + productId)
            .then(response => response.json())
            .then(data => { displayProducts(data)})
            .catch(error => console.error(error));

        // Fetch list of all supermarket data
        fetch('/stock?product_id='+productId)
            .then(response => response.json())
            .then(data => { 
                addPurchaseOptions(data) 
                loadStock(data)
            })
            .catch(error => console.error('Error loading stores data:', error));

        // If no store is set, client needs to choose a store for his delivery
        if(storeId==null) {
            //Get list of all supermarkets
            fetch('/getStores')
                .then(response => response.json())
                .then(data => {
                    addOrderPurchaseOptions(data)
                })
                .catch(error => console.error('Error loading stores data:', error));
        }
        else{
            // Fetch list of selected supermarket data
            fetch('/stock?supermarket_id='+storeId+'&product_id='+productId)
                .then(response => response.json())
                .then(data => {
                    if(data[0]==null) {
                        toggleCart()
                    }
                })
                .catch(error => console.error('Error loading stores data:', error));
        }

        function displayProducts(products) {

            const container = document.getElementById('product-details-container');
            const whatitem = document.getElementById('whatitem');
            const pageTitle = document.getElementById('pageTitle')
            const category = document.getElementById('category');
            const categoryHTML = products.map(product =>  `${product.categoryID}`).join('');
            category.innerText = categoryHTML;
            category.href='/products?type='+categoryHTML.toLowerCase();

            const whatitemHTML = products.map(product =>  `${product.name}`).join('');
            whatitem.innerHTML = whatitemHTML;
            pageTitle.innerHTML = whatitemHTML;

            let maxStock;
            //document.getElementById('supermarketIdInput').value = productId
            // Create HTML markup for each product
            const productsHTML = products.map(product => `

                  <div class="product-details">
                <div class="product-image">
                  <img src="${product.imageSource}" alt="${product.name}">
                </div>
                <div class="product-info">
                  <p id="store-name-label" style="visibility: hidden;font-style: italic"></p>
                  <h2 class="product-name">${product.name}</h2>
                  <p class="product-price">€${product.price}</p>
                  <div class="add-to-cart">
                    <button class="add-to-cart-button" id="a2c" onclick="toggleModal('.order','open')"> <!-- onclick="addToCart(${product.id})" -->
                        <i class="fas fa-shopping-cart"></i> Add to Cart
                    </button>
                  </div>
                  <div class="add-to-cart">
                      <button class="add-to-cart-button btn btn-open" onclick="toggleModal('.locate','open')">
                      <i class="fas fa-store"></i> View Supermarket Availability
                      </button>
                      <!-- <select class="store-selection" id="options"> -->
                            <!-- Supermarkets from db function addPurchaseOptions -->
                      <!-- </select> -->
                      <!-- <button id="locationButton">-->
                      <!-- <i class="fas fa-map-marker-alt"></i> Use My Location-->
                      <!-- </button>-->
                      <br>
                  </div>
                  <p class="product-description">${product.description}</p>
                </div>
              </div>
            `).join('');

            // Add the HTML markup to the container
            container.innerHTML = productsHTML;
            // Set storename
            if(storeName){
                let s=document.getElementById("store-name-label")
                s.innerHTML= "Selected store: "+ storeName + " <br><a href=clearSession?product_id=" + productId + ">Select a different one</a> (Product availability may change)"
                document.getElementById("store-name-label").style.visibility="visible"
            }
        }

        // Add supermarkets from db data - SEE STOCK
        function addPurchaseOptions(supermarkets) {
            console.log(supermarkets);
            let supermarketOptions;
            if (supermarkets.length!=0) {
                supermarketOptions = supermarkets.map(stock =>
                        `<hr><div class="subcard">
                            <p class="place">${stock.supermarket.name}</p>
                            <p class="distanceText" style="font-style: italic">Διαθέσιμη ποσότητα: ${stock.quantity}</p>
                        </div>`
                ).join('');
            } else {
                supermarketOptions = '<br><h6 style="text-align: center;color:#6a8f65">Oops! No stock available</h6><img src="/images/global/out_of_stock_3.jpg"  class="w3-round-xxlarge" style="margin: auto; display: block; width:80%" alt="out of stock">'
                toggleCart()
            }
            let opt = document.getElementById("options");
            opt.innerHTML = supermarketOptions;
        }

        const numberInput = document.getElementById('quantity-input');
        function loadStock(supermarkets) {
            for (let i = 0; i < supermarkets.length; i++) {
                const entry = supermarkets[i];
                if (entry.supermarket.id === storeId) {
                    document.getElementById("qty").innerText=": "+entry.quantity+" piece(s)";
                    numberInput.max=entry.quantity;
                    maxStock=entry.quantity;
                }
            }
            // If the supermarket id is not found, you can return an appropriate value or throw an error
            return null;
        }

        // Add supermarkets from db data - SELECT SUPERMARKET
        function addOrderPurchaseOptions(supermarkets) {
            console.log(supermarkets);
            const supermarketOptions = supermarkets.map(supermarket =>
            `
            <hr>
            <div class="subcard" style="display: flex; justify-content: space-between;">
              <div>
                <p class="place">${supermarket.name}</p>
                <p class="distanceText" style="font-style: italic;margin-bottom:0">Διεύθυνση: ${supermarket.address}</p>
              </div>
              <div style="display: flex; align-items: center;">
                <input type="radio" name="supermarket_id" value="${supermarket.id}">
              </div>
            </div>
            `
            ).join('');
            let opt = document.getElementById("purchaseOptions");
            opt.innerHTML = supermarketOptions;
        }

        function toggleModal(section,f){
            const modal = document.querySelector(section);
            const overlay = document.querySelector(".overlay");
            if(f==="open"){
                modal.classList.remove("hidden");
                overlay.classList.remove("hidden");
            }
            else{
                modal.classList.add("hidden");
                overlay.classList.add("hidden");
            }
        }

        function addToCart(){
            let quantity = document.getElementById("quantity-input").value;
            $.ajax({
                type: 'POST',
                url: '/cart/add?id='+productId+'&quantity='+quantity+'&storeId='+storeId+'&maxStock='+maxStock,
                error : function() {
                    console.log("error");
                },
                success: function () {
                    toggleModal('.order','close')
                    showSnackbar()
                }
            });
        }

        function setSupermarket(){

            const radios = document.getElementsByName('supermarket_id');
            let supermarket;
            for (let i = 0; i < radios.length; i++) {
                if (radios[i].checked) {
                    console.log(radios[i].value)
                    supermarket = radios[i].value;
                    break;
                }
            }
            if(supermarket!=null) {
                $.ajax({
                    type: 'POST',
                    url: '/setStore?id=' + productId + '&supermarket_id=' + supermarket,
                    error: function () {
                        showSnackbar("Something went wrong. Please Try again later")
                        console.log("error");
                    },
                    success: function () {
                        location.reload()
                    }
                });
            }
            else{
                showSnackbar("Something went wrong. Please Try again later")
            }
        }

        // Wait for the button to be created
        async function toggleCart() {
            while (true) {
                await sleep(100); // Wait for 100 milliseconds before checking again
                const addToCartButton = document.getElementById("a2c");
                if (addToCartButton) {
                    addToCartButton.disabled=true
                    break; // Button is created, exit the loop
                }
            }
        }

        // Sleep function to introduce a delay
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showSnackbar(text) {
            var snackbar = document.getElementById("snackbar");
            if(text){
                snackbar.innerText=text
            }
            snackbar.className = "show";
            setTimeout(function(){ snackbar.className = snackbar.className.replace("show", ""); }, 3000);
        }

        const minusButton = document.getElementById('minusButton');
        const plusButton = document.getElementById('plusButton');

        function validateRange() {
            const value = parseInt(numberInput.value);

            if (value === 1) {
                minusButton.disabled = true;
                plusButton.disabled = false;
            } else if (value == numberInput.max) {
                minusButton.disabled = false;
                plusButton.disabled = true;
            } else {
                minusButton.disabled = false;
                plusButton.disabled = false;
            }
        }

        function decrementNumber() {
            const currentValue = parseInt(numberInput.value);

            if (currentValue > 1) {
                numberInput.value = currentValue - 1;
                validateRange();
            }
        }

        function incrementNumber() {
            const currentValue = parseInt(numberInput.value);

            if (currentValue < numberInput.max) {
                numberInput.value = currentValue + 1;
                validateRange();
            }
        }

    </script>

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/scripts.js"></script>
</div>
</body>
</html>


<script>
    /*
const urlParams = new URLSearchParams(window.location.search);
const productData = urlParams.get('products');
const products = JSON.parse(decodeURIComponent(productData));
fetch('/all')
    .then(response => response.json())
    .then(data => {
        // Process the retrieved data
        displayProducts(data);
    })
    .catch(error => console.error(error));

function displayProducts(products) {
    // Access the product-container element
    const container = document.getElementById('product-container');

    // Create HTML markup for each product
    const productsHTML = products.map(product => `
<div>
<h3>${product.name}</h3>
<p>Description: ${product.description}</p>
<p>Category ID: ${product.categoryID}</p>
<p>Price: ${product.price}</p>
</div>
`).join('');

    // Add the HTML markup to the container
    container.innerHTML = productsHTML;
}

 */
</script>
