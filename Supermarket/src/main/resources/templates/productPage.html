<!DOCTYPE HTML>
<html layout:decorate="Layouts/defaultLayout">
    <head>
        <title id="pageTitle">Product name</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/style.css" rel="stylesheet">
        <link href="css/cardStyle.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
        <link href="/css/map.css" rel="stylesheet">

        <style>
            .product-details {
                display: flex;
                align-items: center;
                margin-bottom: 20px;
            }

            .product-image {
                flex: 0 0 auto;
                margin-right: 20px;
                padding: 30px;
            }

            .product-image img {
                max-width: 400px;
                height: auto;
                border-radius: 5px;
                box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            }

            .product-info {
                flex: 1 1 auto;
            }

            .product-name {
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 10px;
            }

            .product-price {
                font-size: 16px;
                margin-bottom: 10px;
            }

            .add-to-cart {
                margin-bottom: 10px;
            }

            .add-to-cart button {
                background-color: #6a8f65;
                color: white;
                padding: 10px 15px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
                transition: background-color 0.3s ease;
            }

            .add-to-cart button:hover {
                background-color: #506b4b;
            }

            .quantity-input {
                width: 50px;
                padding: 5px;
                border: 1px solid #ccc;
                border-radius: 5px;
            }

            .product-description {
                margin-top: 10px;
                font-size: 20px;
                line-height: 1.4;
                color: #555;
            }

            .store-selection  {
                padding: 10px;
                border-radius: 5px;
                background-color: #f1f1f1;
                border: none;
                box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            }

            .store-selection label {
                font-weight: bold;
                margin-right: 10px;
            }

            #locationButton {
                margin-left: 5px;
                padding: 10px 20px;
                background-color: #6a8f65;
                color: #fff;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            #locationButton i {
                margin-right: 5px;
            }

            #locationButton:hover {
                background-color: #506b4b;
            }

            #locationButton:active {
                background-color: #506b4b;
            }

            .modal {
                margin: auto;
                display: flex;
                flex-direction: column;
                justify-content: center;
                gap: 0.4rem;
                width: 450px;
                padding: 1.3rem;
                min-height: 250px;
                position: absolute;
                top: 20%;
                background-color: white;
                border: 1px solid #ddd;
                border-radius: 15px;
                z-index: 2;
            }

            .modal .flex {
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .modal input {
                padding: 0.7rem 1rem;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 0.9em;
            }

            .overlay {
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(3px);
                z-index: 1;
            }

            .hidden {
                display: none;
            }

            .close {
                position: absolute;
                top: 10px;
                right: 10px;
                font-size: 1.5rem;
                font-weight: bold;
                line-height: 1;
                color: #000;
                text-shadow: 0 1px 0 #fff;
                opacity: 0.5;
            }

            .close:hover {
                color: #000;
                text-decoration: none;
                cursor: pointer;
                opacity: 0.75;
            }

            .close:focus,
            .close:active {
                color: #000;
                outline: none;
                opacity: 1;
            }

            .ok{
                cursor:pointer;
                background-color: #eceeef;
            }

        </style>
    </head>


<body>
<div layout:fragment="content">

<div class="container-fluid">
    <!--breadcrumb-->
    <div class="row">
        <div class="col-md-12">
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="#">Home</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="#">Category</a>
                    </li>
                    <li class="breadcrumb-item active" id="whatitem">
                        pp
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <div id="product-details-container" class="product-details-container"></div>
    <section class="modal locate hidden">
        <div class="flex">
            <button class="close" onclick="toggleModal('.locate','close')">&times;</button>
        </div>
        <div>
            <h3>Find supermarkets near you</h3>
            <div id="options">Put your options here</div>
        </div>
        <button class="btn ok" onclick="toggleModal('.locate','close')">Okay</button>
    </section>

    <section class="modal order hidden">
        <div th:if='${session.get("store")==null}'>
            <div class="flex">
                <button class="close">&times;</button>
            </div>
            <div>
                <h3>Select a supermarket for your order</h3>
                <div id="pj">Put your options here</div>
            </div>
            <form action="/setStore?id=1&supermarket_id=1" method="post">
                <button class="btn" type="submit">Set Session Variable</button>
            </form>
        </div>
        <div th:else>
            <div class="flex">
                <button class="close">&times;</button>
            </div>
            <button class="btn ok" onclick="addToCart()">Yeet</button>
        </div>
    </section>
    <div class="overlay hidden"></div>

</div>

    <script>

        // Get the product ID from the query parameter in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        // Fetch the product details from the server
        fetch('/allbyid?id=' + productId)
            .then(response => response.json())
            .then(data => { displayProducts(data)})
            .catch(error => console.error(error));

        // Fetch list of supermarket data
        fetch('/stock?product_id='+productId)
            .then(response => response.json())
            .then(data => { addPurchaseOptions(data) })
            .catch(error => console.error('Error loading stores data:', error));

        // Get list of all supermarkets
        // fetch('/selectStore')
        //     .then(data=>console.log(data))
        //     .catch(error => console.error('Error selecting store:', error));

        function displayProducts(products) {

            const container = document.getElementById('product-details-container');

            const whatitem = document.getElementById('whatitem');
            const pageTitle = document.getElementById('pageTitle')

            const whatitemHTML = products.map(product =>  `${product.name}`).join('');
            whatitem.innerHTML = whatitemHTML;

            pageTitle.innerHTML = whatitemHTML;

            // Create HTML markup for each product
            const productsHTML = products.map(product => `

                  <div class="product-details">
                <div class="product-image">
                  <img src="${product.imageSource}" alt="${product.name}">
                </div>
                <div class="product-info">
                  <h2 class="product-name">${product.name}</h2>
                  <p class="product-price">â‚¬${product.price}</p>
                  <div class="add-to-cart">
                    <input type="number" class="quantity-input" value="1" min="1" id="quantity-input">
                    <button class="add-to-cart-button" onclick="toggleModal('.order','open')"> <!-- onclick="addToCart(${product.id})" -->
                        <i class="fas fa-shopping-cart"></i> Add to Cart
                    </button>
                  </div>
                  <div class="add-to-cart">
                      <button class="add-to-cart-button btn btn-open" onclick="toggleModal('.locate','open')">
                      <i class="fas fa-store"></i> View Supermarket Availability
                      </button>
                      <!-- <select class="store-selection" id="options"> -->
                            <!-- Supermarkets from db function addPurchaseOptions -->
                      <!-- </select> -->
                      <button id="locationButton">
                        <i class="fas fa-map-marker-alt"></i> Use My Location
                      </button>
                      <br>
                  </div>
                  <p class="product-description">${product.description}</p>
                </div>
              </div>
            `).join('');

            // Add the HTML markup to the container
            container.innerHTML = productsHTML;
        }

        // Add supermarkets from db data
        function addPurchaseOptions(supermarkets) {
            console.log(supermarkets);
            const supermarketOptions = supermarkets.map(stock =>
                `<hr><div class="subcard">
                       <p class="place">${stock.supermarket.name}</p>
                       <p class="distanceText" style="font-style: italic">Available quantity: ${stock.quantity}</p>
                </div>`
                // `<option value="${stock.supermarket.id}">${stock.supermarket.name} Quantity:${stock.quantity}</option>`
            ).join('');
            let opt = document.getElementById("options");
            opt.innerHTML = supermarketOptions;
        }

        function toggleModal(section,f){
            const modal = document.querySelector(section);
            const overlay = document.querySelector(".overlay");
            if(f==="open"){
                modal.classList.remove("hidden");
                overlay.classList.remove("hidden");
            }
            else{
                modal.classList.add("hidden");
                overlay.classList.add("hidden");
            }
        }

        function addToCart(){
            let quantity = document.getElementById("quantity-input").value;
            $.ajax({
                type: 'POST',
                url: '/cart/add?id='+productId+'&quantity='+quantity,
                error : function() {
                    console.log("error");
                },
                success: function () {
                    location.reload()
                }
            });
        }
    </script>

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/scripts.js"></script>
</div>
</body>
</html>


<script>
    /*
const urlParams = new URLSearchParams(window.location.search);
const productData = urlParams.get('products');
const products = JSON.parse(decodeURIComponent(productData));
fetch('/all')
    .then(response => response.json())
    .then(data => {
        // Process the retrieved data
        displayProducts(data);
    })
    .catch(error => console.error(error));

function displayProducts(products) {
    // Access the product-container element
    const container = document.getElementById('product-container');

    // Create HTML markup for each product
    const productsHTML = products.map(product => `
<div>
<h3>${product.name}</h3>
<p>Description: ${product.description}</p>
<p>Category ID: ${product.categoryID}</p>
<p>Price: ${product.price}</p>
</div>
`).join('');

    // Add the HTML markup to the container
    container.innerHTML = productsHTML;
}

 */
</script>
